from string import ascii_uppercase
from collections import Counter, defaultdict, deque, namedtuple  # NOQA


print("Day 20")
def add(a,b):
    return (a[0]+b[0],a[1]+b[1])

UP=(0,-1)
RI=(1,0)
LE =(-1,0)
DO = (0,1)

data= """         A           
         A           
  #######.#########  
  #######.........#  
  #######.#######.#  
  #######.#######.#  
  #######.#######.#  
  #####  B    ###.#  
BC...##  C    ###.#  
  ##.##       ###.#  
  ##...DE  F  ###.#  
  #####    G  ###.#  
  #########.#####.#  
DE..#######...###.#  
  #.#########.###.#  
FG..#########.....#  
  ###########.#####  
             Z       
             Z       """

_data="""                   A               
                   A               
  #################.#############  
  #.#...#...................#.#.#  
  #.#.#.###.###.###.#########.#.#  
  #.#.#.......#...#.....#.#.#...#  
  #.#########.###.#####.#.#.###.#  
  #.............#.#.....#.......#  
  ###.###########.###.#####.#.#.#  
  #.....#        A   C    #.#.#.#  
  #######        S   P    #####.#  
  #.#...#                 #......VT
  #.#.#.#                 #.#####  
  #...#.#               YN....#.#  
  #.###.#                 #####.#  
DI....#.#                 #.....#  
  #####.#                 #.###.#  
ZZ......#               QG....#..AS
  ###.###                 #######  
JO..#.#.#                 #.....#  
  #.#.#.#                 ###.#.#  
  #...#..DI             BU....#..LF
  #####.#                 #.#####  
YN......#               VT..#....QG
  #.###.#                 #.###.#  
  #.#...#                 #.....#  
  ###.###    J L     J    #.#.###  
  #.....#    O F     P    #.#...#  
  #.###.#####.#.#####.#####.###.#  
  #...#.#.#...#.....#.....#.#...#  
  #.#####.###.###.#.#.#########.#  
  #...#.#.....#...#.#.#.#.....#.#  
  #.###.#####.###.###.#.#.#######  
  #.#.........#...#.............#  
  #########.###.###.#############  
           B   J   C               
           U   P   P               """

data = """                               O         L       Z Z   P       X         P                                   
                               E         W       Z P   F       W         S                                   
  #############################.#########.#######.#.###.#######.#########.#################################  
  #...#.#.#.#.#.#...........#.#.......#.....#.#.#.....#.#.....#.#.....#.#...........#.....#.#.#.#.#.#...#.#  
  #.###.#.#.#.#.#####.#.###.#.#######.###.###.#.#.#.###.#.###.#.###.###.###.###########.###.#.#.#.#.#.###.#  
  #.#.....#...........#...#.....#...#.#.......#...#...#...#...#.#...#...........#...#.#...................#  
  #.###.#####.#.###.#.###.###.#####.#.#.#######.###########.#.#.#.#.#########.###.###.#.###.#.#.#.###.###.#  
  #.....#.....#.#.#.#...#.#...........#...#.#...#...#.#.....#.#...#...#...........#.#.#...#.#.#.#.#...#...#  
  #####.#######.#.#########.#.#.#.###.#.#.#.###.###.#.#.###.#.###.#.#.#.#.#.#####.#.#.#.#######.#.###.###.#  
  #...#.....#...#.#.#.......#.#.#...#.#.#.....#.....#...#...#.#.#.#.#.#.#.#.....#.#...#...#...#.#...#...#.#  
  #.###.#########.#.#.#####.#####.###.###.###.#.#######.#######.#####.#######.###.###.#.#####.###.#########  
  #...#.#...#.#.#.#.#.#.....#.......#...#.#...#.......#...#...............#...#.....#...........#.#...#.#.#  
  #.###.###.#.#.#.#.#####.#####.#.#.#######.#.###.#####.#######.#.###.###.###.#####.#.#.###########.###.#.#  
  #.........#.....#...#...#.....#.#.#...#.#.#.#...#...#.....#.#.#.#.#.#.#.#.....#.#...#.#.#.#.#...#.#.#.#.#  
  ###.#######.#######.#.###.#####.#####.#.###.#.#####.#.#####.#####.#.#.#.###.###.###.###.#.#.#.###.#.#.#.#  
  #.........#.#.#.#...#.#.#.#...........#.#.#.#...#.#.....#.#.......#...#.#.#.#...#.#.........#...#.#.#...#  
  #.#########.#.#.#.#####.#######.#.#.#.#.#.#.###.#.###.###.#.#.###.#.#####.#.#.###.###.#.#.###.#.#.#.#.###  
  #.....#.......#...#.........#...#.#.#.#.....#.....#.......#.#...#.#.#.........#.......#.#.#.#.#.#.#.....#  
  ###.#.###.#####.#######.###.#.###.#.#####.#####.#.###.#######.#####.#.###############.###.#.#.###.###.###  
  #.#.#.#...#.....#...#...#...#...#.#.#.#.#.#...#.#...#...#.#.....#.#.#.#.............#.#...#...#.....#...#  
  #.#.###.#####.#####.#######.#.#######.#.#.###.#####.#.###.#.#.###.#.#.#.#.#.#####.###########.#.#####.###  
  #.......#.#...#.#...#.#...........#.#.#.....#.......#...#.#.#.......#...#.#.#...#.#.#.#.#.........#.#...#  
  #.###.###.###.#.###.#.#########.###.#.#.#.###.###.###.###.#####.###.#####.###.#####.#.#.#####.###.#.#.#.#  
  #.#.....#.#...#.#.#...#.#.........#...#.#.#...#...#.......#.....#.#.#...........#.........#.#.#.#.#...#.#  
  #######.#.###.#.#.#.###.#######.###.#.###.###.###.###.###.#.#.###.###.#.###.#####.#########.#.#.###.#####  
  #...........#.#.#.....#.............#.#.#.#.....#.#...#.#.#.#.......#.#.#.....#.#.#...#.#...#.....#...#.#  
  #########.###.#.#.#######.#.#.#####.###.#.#####.#.#.###.#.###.#####.#.#####.###.#.###.#.#.#####.###.###.#  
  #.#.#.#.#.#...#.....#.#.#.#.#.#.........#...#...#.#.#.......#.#.....#...#...#...#.#...#.#.....#...#.....#  
  #.#.#.#.#.###.#.#.#.#.#.#######.#########.###.###########.#####.#####.#########.#.###.#.###.###.#####.#.#  
  #...#.#.....#...#.#.#...#.#    Y         H   N           T     S     W        #.#.#.....#.#.#...#.#.#.#.#  
  #.###.###.###.#.#####.###.#    T         V   P           Z     B     Z        #.#.###.#.#.#.###.#.#.#.###  
  #.#...#.#.....#...#.....#.#                                                   #.....#.#...........#...#.#  
  #.###.#.#.#.#########.#.#.#                                                   #.#.#####.#########.#.#.#.#  
TZ......#...#.....#...#.#...#                                                 PF..#.#...#.....#.......#....TF
  #.#.#####.#.#####.#.#####.#                                                   #.#.#.#.###.#.###.#.#####.#  
  #.#...#...#.....#.#.#.#...#                                                   #.#.#.#...#.#.#.#.#.#.....#  
  ###.#.#.###.#.#.###.#.###.#                                                   #.#.#.###.#.###.###########  
  #.#.#...#...#.#............XH                                                 #.#...#.....#.#.....#.....#  
  #.#####.#####.#.#.#.###.#.#                                                   ###.#########.###.#.#####.#  
  #...#.#.#.....#.#.#.#.#.#.#                                                   #...#.............#.#.....#  
  #.#.#.#.#########.###.#####                                                   ###.#.###.#.#####.#####.#.#  
NJ..#.#.#.#...#.#.#.....#...#                                                   #.#.#...#.#.#...........#..NP
  ###.#.###.#.#.#.#.#######.#                                                   #.#####.#####.###.###.#.###  
  #.....#.#.#.#...#.#.......#                                                   #.......#...#.#.....#.#...#  
  #####.#.#.#####.###.#.###.#                                                   #.#########.###############  
  #...#...............#.#.#..KX                                               PS....#.....#.#.#.#...#...#.#  
  #.#####################.###                                                   #########.#.#.#.#.#####.#.#  
  #.................#.......#                                                   #..........................YT
  #.###.#.#.###.###.#.###.###                                                   #.###.###.#.#.#.#.###.###.#  
KX....#.#.#.#...#.....#.....#                                                 IF....#.#...#.#.#.#...#.#...#  
  #.###.###.#####.#.###.#####                                                   #########.#################  
  #.#...#...#.#...#.#........XW                                                 #...#...#.#.#.#.#..........HV
  #.###.###.#.#####.#.#######                                                   #.#####.###.#.#.#.#####.#.#  
  #.#.#.#.#.#.#...#.#.#.#...#                                                 XG..#.#.#...#...#...#...#.#.#  
  ###.###.###.###.#####.#.#.#                                                   #.#.#.#.###.#.#.#.#.#####.#  
  #.#.#.#.#.#.#.#.........#.#                                                   #...#.......#.#.#.#...#.#.#  
  #.#.#.#.#.#.#.#######.###.#                                                   #.#####.#.#.#####.###.#.###  
SO....#.........#.#.....#...#                                                   #.......#.#.......#...#.#.#  
  #.###.###.#.#.#.###.###.###                                                   #####.#.#####.#######.#.#.#  
  #.....#...#.#.......#.#....XX                                               MU..#...#.....#.#...........#  
  #.#.###.#####.#####.#.#.###                                                   #.#####.#######.#######.###  
  #.#.#.#.#.#.....#.....#.#..YH                                                 #.#.#...#.#...........#...#  
  #####.###.###############.#                                                   #.#.#####.#.###.#.#.###.#.#  
  #...#...#...#.#.#...#...#.#                                                   #.#...#.#.#...#.#.#...#.#..TH
  #.#####.#.###.#.#.###.###.#                                                   #.#.###.#.#######.#########  
XH..#.#.#.....#.#...#...#.#.#                                                   #...................#.#...#  
  #.#.#.#.#.###.###.#.#.#.#.#                                                   #####################.###.#  
  #.......#...........#.....#                                                   #.....#.........#..........VD
  #########.###.###.#.#.#.###                                                   #.###.#.#.#.###.#.#.#####.#  
IF......#.#.#.#.#...#.#.#.#.#                                                 OE..#...#.#.#.#.....#...#...#  
  #.#####.#.#.#######.#.###.#                                                   #.#.###.###.###.###.#.#.###  
  #...#.#.#...#.#.#...#.#.#..LW                                                 #.#...#...#.#.....#.#.#.#..AA
  #.#.#.#.#####.#.#######.#.#                                                   #####.#.#.#####.#.###.#.#.#  
YH..#.#...#.......#...#...#..NJ                                                 #.......#.#...#.#.#...#...#  
  #.###.#.###.#.#.#.###.#.#.#                                                   #####.#####.#.#######.#####  
  #.....#.....#.#.......#...#                                                   #.#.....#.#.#.#.#...#.#...#  
  ###########################                                                   #.###.###.#.###.#.#####.#.#  
  #...............#.#.......#                                                   #.#.#.#.#.....#...#.....#..KI
  ###.#####.#.###.#.#.#.#.#.#                                                   #.#.###.#.#######.#####.#.#  
  #.....#.#.#.#.....#.#.#.#..SO                                               TF..#...#...#.#.......#...#.#  
  #.#####.###.###.#.###.#.#.#                                                   #.#.#.#.#.#.###.#.###.###.#  
WZ..........#.#.#.#.#.#.#.#.#                                                   #...#...#.......#.......#.#  
  #.###.#.#.###.###.#.#.###.#                                                   #.#.###.#.#.###.#.###.#####  
  #...#.#.#.#.............#.#                                                   #.#...#.#.#...#.#...#.....#  
  #.###.#####.#####.#.#.###.#      Q           T       K   V         Z     T    ###.#.#.#####.#.###.#.#.###  
  #.#.....#.#...#...#.#...#.#      B           H       I   D         P     G    #...#.#...#...#...#.#.#...#  
  #########.#.###.###.#####.#######.###########.#######.###.#########.#####.###########.###.#.#.#.#####.###  
  #...#.......#.#...#.#.#.#.#.#.........#.#.#...#...#...#...#.#.#.....#.....#...#...#.#.#...#.#.#...#.....#  
  ###.#.#.#####.#.#####.#.###.###.###.###.#.#.###.#.###.#.###.#.#.#######.#.#.###.###.#.#####.###.#.#.#.###  
  #.....#.#.......#...#.#.........#.....#.#.#.#...#...#.#.....#.........#.#...#...#...#.....#.#...#.#.#...#  
  #.#.#.###.#####.#.###.#.###.#.#####.#.#.#.#.###.###.#.#.#.#.#.#.#.#########.#.###.#.#########.#.#.###.###  
  #.#.#.#...#.#.........#.#...#.#.#...#.#.....#...#.#...#.#.#.#.#.#...#...#.#.......#.....#...#.#.#...#...#  
  #.#####.###.#.#####.#######.###.#.###.#.#######.###.###.#####.###.###.###.#.#.###.###.#.#.#.###.#.###.###  
  #.#...#.#.......#.........#.#.....#.#.#.......#.#.#.#.....#.#.#.......#.....#...#.#.#.#...#.#...#...#...#  
  #.###.#.#.###.###.#.#######.#######.#.#######.#.#.#.###.#.#.#.#####.###.#.###.###.#.###.###.#####.#.#.#.#  
  #.#.....#...#...#.#.#...#.#.#.#.........#.#...#...#.#...#...#.#.......#.#...#...#.....#...#.#.#.#.#.#.#.#  
  ###.#.#.#.#.###.###.###.#.###.#######.###.#.#.#.#.#####.#.#########.#.###.#########.###.###.#.#.#.#######  
  #...#.#.#.#.#...#...#.......#...#.#.....#...#.#.#.....#.#.#.....#...#.#...#.....#.#.#.....#.#...........#  
  ###.###.#####.#####.#####.###.###.###.#######.#.#.#######.###.#.###.#####.#.#####.#####.#.###.#.#####.#.#  
  #.....#.#...#.#.....#.....#.#.#...#.#.#...#...#.#.#.#...#...#.#.....#...#...........#...#.#.#.#.#.....#.#  
  #.###.#####.#.#####.#####.#.#.###.#.#.#.#####.#.###.###.###.#####.#.###.#.#.###.###########.###.#####.#.#  
  #.#.#.#.......#...#.#...............#...#.#...#...#.........#.....#.#.....#.#.#.#.........#.#.......#.#.#  
  ###.#######.#####.#######.#.###.###.#.#.#.###.#.#.#######.#.#.#.#.###.###.###.###.#########.###.#########  
  #.#...#...#.#.#.#...#.....#.#...#.#.#.#.#.....#.#.#.#.#...#.#.#.#.#.....#.......#.....#.#.....#...#...#.#  
  #.#.#####.###.#.#.#.#.#.#######.#.#.#.#####.###.###.#.#####.#.#######.#######.###.#.###.#.#########.###.#  
  #.....#...#.....#.#.#.#.#.......#.#...#.#...#.#...#.#...#.#.#...#.#.........#.#...#.#.............#.#...#  
  #.###.#.#.###.#####.#.#########.#.#####.#.###.#.###.#.###.#.###.#.#####.#.#####.#####.#.#.#.#.###.#.###.#  
  #.#.#.#.#.............#.................#.#...#.#.....#.......#.....#...#.#.....#.....#.#.#.#.#.#.......#  
  ###.#.#####.###.#.#####.#.###.#.#.###.#.#.#.#.#.###.#####.#####.#.#.###.###.#######.###########.#.#####.#  
  #.............#.#.#.#...#.#...#.#.#...#.#.#.#.#...#...#.......#.#.#.#...#.....................#.#.....#.#  
  #####.#.###.#.#.###.###.###.#.###.#.#####.#.#.#.###.#######.#######.#.###.#.#.#.#.#.###.#.#####.###.###.#  
  #.....#...#.#.#.#.......#...#.#...#.#.......#.#.........#...#.......#.....#.#.#.#.#...#.#.......#.....#.#  
  ###################################.#########.#####.#####.#####.###########.#############################  
                                     X         S     T     Q     M           X                               
                                     G         B     G     B     U           X                               """

_data="""             Z L X W       C                 
             Z P Q B       K                 
  ###########.#.#.#.#######.###############  
  #...#.......#.#.......#.#.......#.#.#...#  
  ###.#.#.#.#.#.#.#.###.#.#.#######.#.#.###  
  #.#...#.#.#...#.#.#...#...#...#.#.......#  
  #.###.#######.###.###.#.###.###.#.#######  
  #...#.......#.#...#...#.............#...#  
  #.#########.#######.#.#######.#######.###  
  #...#.#    F       R I       Z    #.#.#.#  
  #.###.#    D       E C       H    #.#.#.#  
  #.#...#                           #...#.#  
  #.###.#                           #.###.#  
  #.#....OA                       WB..#.#..ZH
  #.###.#                           #.#.#.#  
CJ......#                           #.....#  
  #######                           #######  
  #.#....CK                         #......IC
  #.###.#                           #.###.#  
  #.....#                           #...#.#  
  ###.###                           #.#.#.#  
XF....#.#                         RF..#.#.#  
  #####.#                           #######  
  #......CJ                       NM..#...#  
  ###.#.#                           #.###.#  
RE....#.#                           #......RF
  ###.###        X   X       L      #.#.#.#  
  #.....#        F   Q       P      #.#.#.#  
  ###.###########.###.#######.#########.###  
  #.....#...#.....#.......#...#.....#.#...#  
  #####.#.###.#######.#######.###.###.#.#.#  
  #.......#.......#.#.#.#.#...#...#...#.#.#  
  #####.###.#####.#.#.#.#.###.###.#.###.###  
  #.......#.....#.#...#...............#...#  
  #############.#.#.###.###################  
               A O F   N                     
               A A D   M                     """
    
print(data)
bd = {}
mx=my=0
for y, line in enumerate(data.split("\n")):
    my=max(my,y)
    for x, char in enumerate(line):
        bd[(x,y)] = char
        mx=max(mx,x)

def is_outer(point):
    if point[0]<3 or point[1]<3:
        return True
    if point[0]> mx-4 or point[1]>my-4:
        return True
    return False

portals_by_name = defaultdict(set)
portals_by_loc = {}

for point, char in bd.items():
    if char!=".":
        continue

    #is it next to a portal?
    for d in (UP,RI, LE, DO):
         n = add(point, d)
         if bd[n] in ascii_uppercase:
             n2 = add(n,d)

             name = "".join(sorted([bd[n],bd[n2]]))
             portals_by_name[name].add(point)
             portals_by_loc[point]=name

print(portals_by_name)
print(portals_by_loc)

q=deque()
q.append((list(portals_by_name['AA'])[0], 0, (('AA',0),),0,[]))
seen= set()
while q:
    state = q.popleft()
   
    loc = state[0]
    dist = state[1]
    passed_through=state[2]
    depth= state[3]
    path =state[4]
    if depth<0:
        continue

    k = (loc, depth, frozenset(passed_through)) 
    if k in seen:
        continue
    seen.add(k)
    
    if len(seen)%100000==0:
        print(len(seen))
        print(state)

    if bd[loc]!="." and loc not in portals_by_loc:
        continue

    if loc in portals_by_loc:
        name = portals_by_loc[loc]

        if name == "AA":
            pass
        elif name == "ZZ":
            if depth!=0:
                continue
            else:
                print(dist, depth, )
                break
                            
        elif (name,depth) not in passed_through:
            if is_outer(loc):
                depth-=1
                dist+=1
            else:
                depth+=1
            loc = [a for a in portals_by_name[name] if a !=loc][0]
            passed_through=tuple([a for a in passed_through]+[(name,depth)])
            
            
            path= list(path)
            path.append((name,depth,dist))
            
            

    for d in (UP,RI, LE, DO):
        q.append((add(loc,d),dist+1, passed_through,depth, path))
                                   
                        
            
    

